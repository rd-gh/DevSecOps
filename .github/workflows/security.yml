name: .NET Security Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'S1A/**'
  pull_request:
    branches: [main]
    paths:
      - 'S1A/**'

permissions:
  contents: read
  security-events: write

jobs:
  semgrep:
    name: Semgrep SAST (C#)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: returntocorp/semgrep-action@v1
        with:
          config: https://semgrep.dev/p/csharp
          generateSarif: true
          output: semgrep-results
      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif

dependency-check:
  name: OWASP Dependency Scan
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    - name: Set JAVA_HOME
      run: echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV

    - name: Run OWASP Dependency-Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: "SecurityDemo"
        scanPath: "."
        format: "HTML"
        out: "dependency-report"

    - name: Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: dependency-report

  gitleaks:
    name: Secret Scan (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_LICENSE_KEY: ${{ secrets.GITLEAKS_LICENSE_KEY }}

  dotnet-lint:
    name: Linting with dotnet-format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - run: dotnet tool install -g dotnet-format
      - run: dotnet-format S1A/SecurityDemo.csproj --check --verbosity diagnostic

  codeql:
    name: CodeQL SAST
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: csharp
      - name: Build
        run: dotnet build S1A/SecurityDemo.csproj --configuration Release
      - uses: github/codeql-action/analyze@v3